import RPi.GPIO as GPIO
import time

TRIG = 23
ECHO = 24
YELLOW = 27
RED = 17
BUZZER = 21

GPIO.setmode(GPIO.BCM)
GPIO.setup(TRIG, GPIO.OUT)
GPIO.setup(ECHO, GPIO.IN)
GPIO.setup(YELLOW, GPIO.OUT)
GPIO.setup(RED, GPIO.OUT)
GPIO.setup(BUZZER, GPIO.OUT)

GPIO.output(TRIG, False)
GPIO.output(YELLOW, False)
GPIO.output(RED, False)
GPIO.output(BUZZER, True)

time.sleep(2)

motion_state = "none"

def get_distance():
    GPIO.output(TRIG, True)
    time.sleep(0.00001)
    GPIO.output(TRIG, False)

    timeout = time.time() + 0.02
    while GPIO.input(ECHO) == 0 and time.time() < timeout:
        pulse_start = time.time()

    timeout = time.time() + 0.02
    while GPIO.input(ECHO) == 1 and time.time() < timeout:
        pulse_end = time.time()

    try:
        duration = pulse_end - pulse_start
        distance = duration * 17150
        return round(distance, 1)
    except:
        return None

def beep_short():
    GPIO.output(BUZZER, False)
    time.sleep(0.15)
    GPIO.output(BUZZER, True)
    time.sleep(0.1)

def beep_long():
    GPIO.output(BUZZER, False)
    time.sleep(0.6)
    GPIO.output(BUZZER, True)

try:
    while True:
        d = get_distance()
        if d is None:
            continue

        print(f"Distance: {d} cm")

        if 25 <= d <= 50:
            if motion_state != "yellow":
                motion_state = "yellow"
                GPIO.output(YELLOW, True)
                GPIO.output(RED, False)
                beep_short()
                beep_short()
        elif 5 <= d < 25:
            if motion_state != "red":
                motion_state = "red"
                GPIO.output(RED, True)
                GPIO.output(YELLOW, False)
                beep_long()
        else:
            if motion_state != "none":
                motion_state = "none"
                GPIO.output(YELLOW, False)
                GPIO.output(RED, False)
                GPIO.output(BUZZER, True)

        time.sleep(0.1)

except KeyboardInterrupt:
    GPIO.cleanup()
